<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Test Login & Chat</title>
</head>
<body>
  <h2>ƒêƒÉng nh·∫≠p</h2>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="M·∫≠t kh·∫©u">
  <button onclick="login()">ƒêƒÉng nh·∫≠p</button>

  <pre id="loginResult"></pre>

  <hr>

  <h2>Test t·∫°o room</h2>
  <input id="sellerId" placeholder="seller_id (ID m√¥i gi·ªõi)">
  <input id="listingId" placeholder="listing_id (ID b√†i ƒëƒÉng)">
  <button onclick="createRoom()">T·∫°o ph√≤ng</button>

  <pre id="roomResult"></pre>

  <hr>

  <h2>Test WebSocket chat</h2>
  <input id="roomId" placeholder="room_id">
  <button onclick="connectWs()">Connect WS</button><br><br>

  <input id="msgText" placeholder="N·ªôi dung tin nh·∫Øn">
  <button onclick="sendMsg()">G·ª≠i</button>

  <pre id="wsLog"></pre>

  <script>
    let accessToken = null;
    let socket = null;

    async function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      const res = await fetch("http://127.0.0.1:8000/api/accounts/login/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password })
      });

      const data = await res.json();
      document.getElementById("loginResult").textContent = JSON.stringify(data, null, 2);

      if (res.ok && data.access) {
        accessToken = data.access;
        alert("ƒêƒÉng nh·∫≠p OK, ƒë√£ c√≥ access token");
      } else {
        alert("ƒêƒÉng nh·∫≠p l·ªói");
      }
    }

    async function createRoom() {
      if (!accessToken) {
        alert("Ch∆∞a c√≥ access token, ƒëƒÉng nh·∫≠p tr∆∞·ªõc ƒë√£");
        return;
      }

      const sellerId = document.getElementById("sellerId").value;
      const listingId = document.getElementById("listingId").value;

      const res = await fetch("http://127.0.0.1:8000/api/rooms/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + accessToken
        },
        body: JSON.stringify({
          seller_id: sellerId,
          listing_id: listingId || null
        })
      });

      const data = await res.json();
      document.getElementById("roomResult").textContent = JSON.stringify(data, null, 2);

      if (res.ok && data.room_id) {
        document.getElementById("roomId").value = data.room_id;
        alert("T·∫°o room OK, room_id ƒë√£ ƒë∆∞·ª£c set s·∫µn");
      }
    }

    function connectWs() {
      if (!accessToken) {
        alert("Ch∆∞a c√≥ access token, ƒëƒÉng nh·∫≠p tr∆∞·ªõc ƒë√£");
        return;
      }
      const roomId = document.getElementById("roomId").value.trim();
      if (!roomId) {
        alert("Nh·∫≠p room_id tr∆∞·ªõc");
        return;
      }

      const url = `ws://127.0.0.1:8000/ws/chat/${roomId}/?token=${accessToken}`;
      socket = new WebSocket(url);

      socket.onopen = () => {
        logWs("‚úÖ WS connected");
      };

      socket.onmessage = (event) => {
        logWs("üì© " + event.data);
      };

      socket.onclose = () => {
        logWs("‚ùå WS closed");
      };

      socket.onerror = (e) => {
        logWs("‚ö†Ô∏è WS error");
      };
    }

    function sendMsg() {
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        alert("WebSocket ch∆∞a connect");
        return;
      }
      const text = document.getElementById("msgText").value;
      socket.send(JSON.stringify({
        type: "chat.message",
        text: text
      }));
      logWs("üì§ g·ª≠i: " + text);
    }

    function logWs(msg) {
      const pre = document.getElementById("wsLog");
      pre.textContent += msg + "\n";
    }
  </script>
</body>
</html>
